-- ComputerCraft Scripts (C) 2015 Peter "SaberUK" Powell

local BONEMEAL_NAME    = "minecraft:dye"
local BONEMEAL_VARIANT = 15

local SAPLING_NAME    = "BiomesOPlenty:saplings"
local SAPLING_VARIANT = 0

local WOOD_NAME    = "minecraft:log"
local WOOD_VARIANT = 0

os.loadAPI("lib/turtlex")

function boneMealSapling()
	local slot = searchInventory(BONEMEAL_NAME, BONEMEAL_VARIANT)
	if slot then
		turtle.select(slot)
		turtle.place()
	else
		os.sleep(5)
	end
end

function chopDownTree()
	moveCounter = 0
	while true do
		local success, block = turtle.inspect()
		if not success or block.name ~= WOOD_NAME or block.metadata ~= WOOD_VARIANT then
			break
		end
		turtle.dig()
		turtle.digUp()
		turtlex.waitMove(1, turtle.up)
		moveCounter = moveCounter + 1
	end
	turtlex.waitMove(moveCounter, turtle.down)
end

function clearInventory()
	for slot = 1, 16 do
		local info = turtle.getItemDetail(slot)
		if info then
			if info.name == BONEMEAL_NAME and info.damage == BONEMEAL_VARIANT then
				-- Keep Bone Meal
			elseif info.name == SAPLING_NAME and info.damage == SAPLING_VARIANT then
				-- Keep Saplings
			else
				turtle.select(slot)
				turtle.dropDown()
			end
		end
	end
end

function plantSapling()
	local slot = searchInventory(SAPLING_NAME, SAPLING_VARIANT)
	if slot then
		turtle.select(slot)
		turtle.place()
	else
		error("The turtle has run out of saplings!")
	end
end

function searchInventory(name, damage)
	for slot = 16, 1, -1 do
		local info = turtle.getItemDetail(slot)
		if info and info.name == name then
			if not damage or damage == info.damage then
				return slot
			end
		end
	end
end

while true do
	local success, block = turtle.inspect()
	if not success then
		plantSapling()
	elseif block.name == SAPLING_NAME and block.metadata == SAPLING_VARIANT then
		boneMealSapling()
	elseif block.name == WOOD_NAME and block.metadata == WOOD_VARIANT then
		chopDownTree()
		clearInventory()
	else
		error("Unexpected " + block.name + " in the planting area!")
	end
end
